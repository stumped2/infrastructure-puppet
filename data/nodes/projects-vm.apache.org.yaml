---
classes:
  - apache
  - apache::mod::status
  - vhosts_asf::vhosts
  - vhosts_asf::modules
  
apache::keepalive:          'On'
apache::keepalive_timeout:  '15'
apache::max_keepalive_requests: 1000
apache::timeout: 600
apache::default_vhost:      false
apache::docroot:            '/var/www/htdocs'

apache::mod::event::listenbacklog: '511'
apache::mod::event::maxclients: '250'
apache::mod::event::maxconnectionsperchild: '200000'
apache::mod::event::maxrequestworkers: '500'
apache::mod::event::maxsparethreads: '150'
apache::mod::event::minsparethreads: '150'
apache::mod::event::serverlimit: '10'
apache::mod::event::startservers: '5'
apache::mod::event::threadlimit: '250'
apache::mod::event::threadsperchild: '50'

apache::mod::status::allow_from:
  - all
apache::mod::status::apache_version: '2.3'

apache::mpm_module:         'event'
apache::serveradmin:        'dev@community.apache.org'

logrotate::rule:
  apache2:
    ensure: 'present'

vhosts_asf::modules::modules:
  cgi:
    name: 'cgi'

vhosts_asf::vhosts::vhosts:
  projects:
    vhost_name: '*'
    port: 80
    docroot: '/var/www/projects.apache.org/site'
    servername: 'projects.apache.org'
    serveraliases:
      - 'projects-new.apache.org'
    serveradmin: 'dev@community.apache.org'
    directoryindex: 'index.py index.html'
    options:
      - Indexes
      - FollowSymLinks
      - MultiViews
      - ExecCGI
    custom_fragment: |
      AddHandler cgi-script .py
      <Location />
        Require ip 140.211.11.75 140.211.11.138 140.211.11.139 140.211.11.140
      </Location>
      Redirect /feeds http://projects-old.apache.org/feeds
      Redirect /indexes http://projects-old.apache.org/indexes
      
  reporter:
    vhost_name: '*'
    port: 80
    docroot: '/var/www/reporter.apache.org/site'
    servername: 'reporter.apache.org'
    serveradmin: 'dev@community.apache.org'
    directoryindex: 'index.py index.html'
    options:
      - Indexes
      - FollowSymLinks
      - MultiViews
      - ExecCGI
    custom_fragment: |
      AddHandler cgi-script .py
      <Location />
        Require ip 140.211.11.75 140.211.11.138 140.211.11.139 140.211.11.140
      </Location>
      Alias /releases/ /var/www/reporter.apache.org/data/releases/
      
file:
  # ensure log file directories exist
  '/var/log/www-data':
    ensure: directory
      owner:  'www-data'
      group:  'www-data'
      mode:   0775

  '/var/log/www-data-root':
    ensure: directory
      owner:  'root'
      group:  'root'
      mode:   0775

cron:
  # Note: svn add is done by www-data cronjobs running at 40 mins past the hour
  # SVN checkins must run as www-data otherwise the www-data user may have problems issuing SVN commands
  # Check in any updated data/releases files
  # Append stdout to  /var/log/www-data-root/svnreleases_$(date "+%Y-%m").log
  rao_releases_ci:
    minute:     45
    hour:
      - 0
      - 6
      - 12
      - 18
    user:       'root'
    command:    'cd /var/www/reporter.apache.org/data/releases && sudo -n -u www-data svn ci -m "updating report releases data" --username projects_role --password `cat /root/.rolepwd` --non-interactive >>/var/log/www-data-root/svnreleases_$(date "+%Y-%m").log'
  #
  # Check in any updated data/history files
  # These are copied extracts of the files created by parsepmcs.py which is run at 00 min 4,12,20 hours
  rao_history_ci:
    minute:     10
    hour:
      - 4
      - 12
      - 20
    user:       'root'
    command:    'cd /var/www/reporter.apache.org/data/history && sudo -n -u www-data svn ci -m "updating report releases data" --username projects_role --password `cat /root/.rolepwd` --non-interactive >>/var/log/www-data-root/svnhistory_$(date "+%Y-%m").log'
  #
  # Check in any updated/new json files under projects.apache.org
  # The "svn add" job run under www-data is run at 04:10
  pao_json_ci:
    minute:     20
    hour:       4
    user:       'root'
    command:    'cd /var/www/projects.apache.org/site/json && sudo -n -u www-data svn ci -m "updating projects data" --username projects_role --password `cat /root/.rolepwd` --non-interactive >>/var/log/www-data-root/svnjson_$(date "+%Y-%m").log'

# Install ldap3 for use by python cron scripts
python::python_pips:
  ldap3:
    ensure: present